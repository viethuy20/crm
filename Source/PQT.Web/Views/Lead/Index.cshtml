@using PQT.Domain.Enum
@using Resources
@model PQT.Web.Models.LeadModelView

@{
    ViewBag.MenuBarColl = true;
    ViewBag.Title = "Call List";
}


<style>
    #tableLead td, table th {
        text-align: center;
        color: #000;
    }

    /*#tableLead tr:nth-child(2n) td {
        background-color: transparent !important;
    }

    #tableLead tbody tr td.sorting_1 {
        background-color: rgba(0, 0, 0, 0.05) !important;
    }*/

    #tableLead tbody tr.Reject {
        background-color: #f44336 !important;
    }

        #tableLead tbody tr.Reject td {
            color: #fff !important;
        }

    #tableLead tbody tr.Blocked {
        background-color: #ff9800 !important;
    }

        #tableLead tbody tr.Blocked td {
            color: #fff !important;
        }

    #tableLead tbody tr.LOI {
        background-color: #7dd8d2 !important;
    }

    #tableLead tbody tr.Live {
        background-color: #7dd8d2 !important;
    }

    #tableLead tbody tr.Booked {
        background-color: #4caf50 !important;
    }

        #tableLead tbody tr.Booked td {
            color: #fff !important;
        }

    #tableLead tbody tr.RequestNCL {
        background-color: #f8f995 !important;
    }

    #tableLead tbody tr.RequestLOI {
        background-color: #f8f995 !important;
    }

    #tableLead tbody tr.RequestBook {
        background-color: #f8f995 !important;
    }
</style>
<section>
    <div class="row">
        <div class="col-lg-12">
            <h1 class="text-primary" style="color: @Model.Event.BackgroundColor">@ViewBag.Title</h1>
        </div><!--end .col -->
        <div class="col-lg-8">
            <article class="margin-bottom-xxl">
                <p class="lead" style="margin-bottom: 5px;">@Model.Event.EventName</p>
                <p><b>Event Code: </b>@Model.Event.EventCode <b>Start Date:</b> @Model.Event.StartDate.ToString("dd/MM/yyyy") <b>End Date:</b> @Model.Event.EndDate.ToString("dd/MM/yyyy")</p>
            </article>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="card  card-underline">
                <div class="card-head">
                    <div class="tools">
                        <div class="btn-group">
                            <a href="@Url.Action("CallSheet",new{eventId=Model.Event.ID,leadId=Model.Event.ID})" class="btn btn-icon-toggle text-success simple-ajax-popup-align-top-custom" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Start New Call"><i class="fa fa-phone-square fa-2x"></i></a>
                            <a class="btn btn-icon-toggle btn-Expand"><i class="fa fa-expand"></i></a>
                        </div>
                    </div>
                    <header><i class="fa fa-fw fa-phone"></i> My Call List</header>
                </div><!--end .card-head -->
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="tableLead">
                            <thead>
                                <tr>
                                    <th>Date Created</th>
                                    <th>Country</th>
                                    <th>Company</th>
                                    <th>Client Name/Job Title</th>
                                    <th>Direct Line/Mobile number</th>
                                    <th>Call Back</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div><!--end .card-body -->
            </div><!--end .card -->
        </div>

        <div class="col-md-4">
            <div class="card card-bordered style-primary" style="background-color: @Model.Event.BackgroundColor;border-color:@Model.Event.BackgroundColor">
                <div class="card-head">
                    <div class="tools">
                        <div class="btn-group">
                            @*<div class="btn-group">
                                    <a href="#" class="btn btn-icon-toggle dropdown-toggle" data-toggle="dropdown"><i class="md md-colorize"></i></a>
                                    <ul class="dropdown-menu animation-dock pull-right menu-card-styling" role="menu" style="text-align: left;">
                                        <li><a href="javascript:void(0);" data-style="style-default-dark"><i class="fa fa-circle fa-fw text-default-dark"></i> Default dark</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-default"><i class="fa fa-circle fa-fw text-muted"></i> Default</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-default-light"><i class="fa fa-circle fa-fw text-default-light"></i> Default light</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-default-bright"><i class="fa fa-circle fa-fw text-default-bright"></i> Default bright</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-primary-dark"><i class="fa fa-circle fa-fw text-primary-dark"></i> Primary dark</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-primary"><i class="fa fa-circle fa-fw text-primary"></i> Primary</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-primary-light"><i class="fa fa-circle fa-fw text-primary-light"></i> Primary light</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-primary-bright"><i class="fa fa-circle fa-fw text-primary-bright"></i> Primary bright</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-accent-dark"><i class="fa fa-circle fa-fw text-accent-dark"></i> Accent dark</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-accent"><i class="fa fa-circle fa-fw text-accent"></i> Accent</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-accent-light"><i class="fa fa-circle fa-fw text-accent-light"></i> Accent light</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-accent-bright"><i class="fa fa-circle fa-fw text-accent-bright"></i> Accent bright</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-danger"><i class="fa fa-circle fa-fw text-danger"></i> Danger</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-warning"><i class="fa fa-circle fa-fw text-warning"></i> Warning</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-success"><i class="fa fa-circle fa-fw text-success"></i> Success</a></li>
                                        <li><a href="javascript:void(0);" data-style="style-info"><i class="fa fa-circle fa-fw text-info"></i> Info</a></li>
                                    </ul>
                                </div>
                                <a class="btn btn-icon-toggle btn-refresh"><i class="md md-refresh"></i></a>
                                <a class="btn btn-icon-toggle btn-collapse"><i class="fa fa-angle-down"></i></a>
                                <a class="btn btn-icon-toggle btn-close"><i class="md md-close"></i></a>*@

                            <a class="btn btn-icon-toggle btn-Expand-NCL"><i class="fa fa-expand"></i></a>
                        </div>
                    </div>
                    <header><i class="fa fa-fw fa-tag"></i> NCL</header>
                </div><!--end .card-head -->
                <div class="card-body style-default-bright">
                    <div class="table-responsive">
                        <table class="table" id="tableNCList">
                            <thead>
                                <tr>
                                    <th>Date Created</th>
                                    <th>Sales</th>
                                    <th>Country</th>
                                    <th>Organisation</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div><!--end .card-body -->
            </div><!--end .card -->
        </div>
    </div>
</section>


@Html.Script(
    @<script>

         var oTable = $("#tableLead");
         oTable.dataTable({
             "processing": true, // for show progress bar
             "serverSide": true, // for process server side
             "filter": true, // this is for disable filter (search box)
             "orderMulti": false, // for disable multiple column at once
             "stateSave": false,
             "ajax": {
                 "url": "@Url.Action("AjaxGetLeads")?eventId=@Model.Event.ID",
                 "type": "POST",
                 "datatype": "json",
                 "data": function(d) {
                 }
             },
             "columns": [
                 { "data": "CreatedTime", "name": "CreatedTime", "orderable": true },
                 { "data": "Country", "name": "Country", "orderable": true },
                 { "data": "Company", "name": "Company", "orderable": true },
                 { "data": "ClientName", "name": "ClientName", "orderable": true },
                 { "data": "DirectLine", "name": "DirectLine", "orderable": true },
                 { "data": "CallBackDate", "name": "CallBackDate", "orderable": true },
                 { "data": "StatusDisplay", "name": "StatusDisplay", "orderable": false },
                 { "data": "ID", "name": "ID", "orderable": false },
             ],
             "iDisplayLength": 25,
             "aaSorting": [[0, "desc"]],
             "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                 @*$(nRow).find('td:eq(1)').attr("style", "text-align:center");
                $(nRow).find('td:eq(4)').html('<a href="@Url.Action("Detail","Audit")/' + aData["ID"] + '" target="_blank"><i class="md md-more"></i></a>');*@
                 var dropdowns = "";
                 dropdowns +=
                     '<li><a class="simple-ajax-popup-align-top-custom" href="@Url.Action("CallingForm")?leadId=' +
                         aData["ID"] +
                         '"><span class=" text-primary"><i class="fa fa-fw fa-phone"></i> Start Call</span></a></li>';
                 if (aData["StatusCode"] == '@LeadStatus.Initial' || aData["StatusCode"] == '@LeadStatus.Reject') {
                     dropdowns += '<li><a href="#" data-action="RequestNCL" data-id="' +
                         aData["ID"] +
                         '"><span class=" text-info"><i class="md fa-fw md-phone-locked"></i> Request To NCL</span></a></li>';

                     @*dropdowns += '<li><a class="simple-ajax-popup-align-top" href="@Url.Action("RequestAction")?id=' +
                         aData["ID"] +
                         '&requestType=@LeadStatus.RequestNCL"><span class=" text-info"><i class="md fa-fw md-phone-locked"></i> Request To NCL</span></a></li>';*@
                 }
                 if (aData["StatusCode"] == '@LeadStatus.Initial' ||
                     aData["StatusCode"] == '@LeadStatus.Reject' ||
                     aData["StatusCode"] == '@LeadStatus.RequestNCL' ||
                     aData["StatusCode"] == '@LeadStatus.Live') {
                     dropdowns += '<li><a class="simple-ajax-popup-align-top" href="@Url.Action("RequestAction")?id=' +
                         aData["ID"] +
                         '&requestType=@LeadStatus.RequestLOI"><span class=" text-info"><i class="md fa-fw md-mail"></i> Request To LOI</span></a></li>';
                 }
                 if (aData["StatusCode"] != '@LeadStatus.RequestBook' && aData["StatusCode"] != '@LeadStatus.Booked') {
                     dropdowns += '<li><a class="simple-ajax-popup-align-top" href="@Url.Action("RequestAction")?id=' +
                         aData["ID"] +
                         '&requestType=@LeadStatus.RequestBook"><span class=" text-success"><i class="md fa-fw md-my-library-books"></i> Request To Book</span></a></li>';
                 }
                 if (aData["StatusCode"] == '@LeadStatus.RequestBook' || aData["StatusCode"] == '@LeadStatus.RequestLOI') {
                     dropdowns += '<li><a class="simple-ajax-popup-align-top" href="@Url.Action("RequestAction")?id=' +
                         aData["ID"] + '"><span class=" text-success"><i class="md fa-fw md-my-library-books"></i> Update Attachment</span></a></li>';
                 }
                 if (aData["StatusCode"] == '@LeadStatus.RequestNCL'||aData["StatusCode"] == '@LeadStatus.RequestBook'||aData["StatusCode"] == '@LeadStatus.RequestLOI') {
                     dropdowns += '<li><a href="#" data-action="CancelRequest" data-id="' +
                         aData["ID"] +
                         '"><span class=" text-warning"><i class="md fa-fw md-cancel"></i> Cancel Request</span></a></li>';
                 };
                 if (aData["StatusCode"] != '@LeadStatus.Booked') {
                     dropdowns += '<li><a href="#" data-action="' +
                         aData["actionBlock"] +
                         '" data-id="' +
                         aData["ID"] +
                         '"><span class=" text-danger"><i class="md fa-fw md-block"></i> ' +
                         aData["actionBlock"] +
                         '</span></a></li>';
                 };
                 $(nRow).find('td:eq(7)').html('<div class="dropdown"><a class="btn dropdown-toggle btn-default btn-mini btn btn-flat prepend-icon" data-toggle="dropdown" href="#"><i class="fa fa-navicon"></i> <span class="caret"></span></a><ul class="pull-right dropdown-menu">' +
                     dropdowns +
                     '</ul></div>');

                 $(nRow).addClass(aData["ClassStatus"]);
             },
             initComplete: function () {
                 var _table = this;
                 _table.parent().find('input[type="search"]').unbind();
                 var timeOutTyping;
                 _table.parent().find('input[type="search"]').bind('keyup', function (e) {
                     clearTimeout(timeOutTyping);
                     timeOutTyping = setTimeout(function () {
                         _table.fnFilter(_table.parent().find('input[type="search"]').eq(0).val());
                     }, 600);
                 });
             },
         });
         oTable.on('click', '[data-action="RequestNCL"]', function (e) {
             e.preventDefault();
             var $sefl = $(this);
             bootbox.confirm("@Resource.ConfirmRequestNCL", function (isOK) {
                 if (isOK) {
                     $.ajax({
                         url: '@Url.Action("RequestAction")?id=' + $sefl.data('id')+'&requestType=@LeadStatus.RequestNCL',
                         type: 'POST',
                         success: function (data) {
                             if (data == "") {
                                 toastr.success("Request successful");
                                 oTable.fnFilter('');
                             } else {
                                 toastr.error(data);
                             }
                         },
                         error: function () {
                             toastr.error("Request failed");
                         }
                     });
                 }
             });
         });
         oTable.on('click', '[data-action="CancelRequest"]', function (e) {
             e.preventDefault();
             var $sefl = $(this);
             bootbox.confirm("@Resource.ConfirmCancelRequest", function (isOK) {
                 if (isOK) {
                     $.ajax({
                         url: '@Url.Action("CancelRequest")?id=' + $sefl.data('id'),
                         type: 'POST',
                         success: function (data) {
                             if (data == "") {
                                 toastr.success("Cancel successful");
                                 oTable.fnFilter('');
                             } else {
                                 toastr.error(data);
                             }
                         },
                         error: function () {
                             toastr.error("Cancel failed");
                         }
                     });
                 }
             });
         });
         oTable.on('click', '[data-action="Block"]', function (e) {
             e.preventDefault();
             var $sefl = $(this);
             bootbox.confirm("@Resource.ConfirmBlock", function (isOK) {
                 if (isOK) {
                     $.ajax({
                         url: '@Url.Action("BlockLead")/' + $sefl.data('id'),
                         type: 'POST',
                         success: function (data) {
                             if (data == "") {
                                 @*var tr = $sefl.closest('tr')[0];
                                 var td = $(tr).find("td");
                                 $(tr).addClass("@LeadStatus.Blocked.DisplayName");
                                 $(td[6]).text('@LeadStatus.Blocked.DisplayName');
                                 $sefl.attr('data-action', 'Unblock');
                                 $sefl.html('<span class=" text-danger"><i class="md fa-fw md-block"></i> Unblock</span>');*@
                                 toastr.success("Blocked successful");
                                 oTable.fnFilter('');
                             } else {
                                 toastr.error(data);
                             }
                         },
                         error: function () {
                             toastr.error("Block failed");
                         }
                     });
                 }
             });
         });
         oTable.on('click', '[data-action="Unblock"]', function (e) {
             e.preventDefault();
             var $sefl = $(this);
             bootbox.confirm("@Resource.ConfirmUnblock", function (isOK) {
                 if (isOK) {
                     $.ajax({
                         url: '@Url.Action("UnblockLead")/' + $sefl.data('id'),
                         type: 'POST',
                         success: function (data) {
                             if (data == "") {
                                 var tr = $sefl.closest('tr')[0];
                                 var td = $(tr).find("td");
                                 $(tr).removeClass("@LeadStatus.Blocked.DisplayName");
                                 $(td[6]).text('@LeadStatus.Initial.DisplayName');
                                 $sefl.attr('data-action', 'Block');
                                 $sefl.html('<span class=" text-danger"><i class="md fa-fw md-block"></i> Block</span>');
                                 toastr.success("Unblock successful");
                             } else {
                                 toastr.error(data);
                             }
                         },
                         error: function () {
                             toastr.error("Unblock failed");
                         }
                     });
                 }
             });
         });




         var nclTable = $("#tableNCList");
         nclTable.dataTable({
             "processing": true, // for show progress bar
             "serverSide": true, // for process server side
             "filter": true, // this is for disable filter (search box)
             "orderMulti": false, // for disable multiple column at once
             "stateSave": false,
             "ajax": {
                 "url": "@Url.Action("AjaxGetNCList")?eventId=@Model.Event.ID",
                 "type": "POST",
                 "datatype": "json",
                 "data": function (d) {
                 }
             },
             "columns": [
                 { "data": "CreatedTime", "name": "CreatedTime", "orderable": true },
                 { "data": "Salesman", "name": "Salesman", "orderable": true },
                 { "data": "Country", "name": "Country", "orderable": true },
                 { "data": "Company", "name": "Company", "orderable": true },
                 { "data": "ClientName", "name": "ClientName", "orderable": true },
                 { "data": "StatusDisplay", "name": "StatusDisplay", "orderable": true },
             ],
             "iDisplayLength": 100,
             "aaSorting": [[0, "desc"]],
             "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                 @*$(nRow).find('td:eq(1)').attr("style", "text-align:center");
                $(nRow).find('td:eq(4)').html('<a href="@Url.Action("Detail","Audit")/' + aData["ID"] + '" target="_blank"><i class="md md-more"></i></a>');*@
             },
             initComplete: function () {
                 var _table = this;
                 _table.parent().find('input[type="search"]').unbind();
                 var timeOutTyping;
                 _table.parent().find('input[type="search"]').bind('keyup', function (e) {
                     clearTimeout(timeOutTyping);
                     timeOutTyping = setTimeout(function () {
                         _table.fnFilter(_table.parent().find('input[type="search"]').eq(0).val());
                     }, 600);
                 });
             },
         });

         ////Select username event
         //$('#userfilter').change(function () {
         //    oTable.fnDraw();
         //});
         //$('#btnSearch').click(function () {
         //    oTable.fnDraw();
         //});

         $(".btn-Expand").on("click",
             function () {
                 if ($(this).find('i').hasClass("fa-expand")) {
                     $(this).parents(".card").parent().addClass("col-md-12");
                     $(this).parents(".card").parent().removeClass("col-md-8");
                     $(this).find('i').addClass("fa-compress");
                     $(this).find('i').removeClass("fa-expand");
                     oTable.css("width","100%");
                 } else {
                     $(this).parents(".card").parent().removeClass("col-md-12");
                     $(this).parents(".card").parent().addClass("col-md-8");
                     $(this).find('i').removeClass("fa-compress");
                     $(this).find('i').addClass("fa-expand");
                 }
             });

         $(".btn-Expand-NCL").on("click",
             function () {
                 if ($(this).find('i').hasClass("fa-expand")) {
                     $(this).parents(".card").parent().addClass("col-md-12");
                     $(this).parents(".card").parent().removeClass("col-md-4");
                     $(this).find('i').addClass("fa-compress");
                     $(this).find('i').removeClass("fa-expand");
                     nclTable.css("width","100%");
                 } else {
                     $(this).parents(".card").parent().removeClass("col-md-12");
                     $(this).parents(".card").parent().addClass("col-md-4");
                     $(this).find('i').removeClass("fa-compress");
                     $(this).find('i').addClass("fa-expand");
                 }
             });


    </script>
                         )

@Html.Script(
    @<script>

         $(document).on('click', '.simple-ajax-popup-align-top-custom', function (e) {
             e.preventDefault();
             $(this).magnificPopup({
                 type: 'ajax',
                 closeOnBgClick:false,
                 callbacks: {
                     ajaxContentAdded: function () {
                         $('.mfp-container .date-picker,.mfp-container .datepicker').datepicker({
                             autoclose: true,
                             todayHighlight: true,
                             format: 'dd/mm/yyyy'
                         }).on('changeDate', function (ev) {
                             $(this).datepicker('hide');
                         });

                         $(".mfp-container select:not(.select-ajax)").select2({
                             placeholder: "@Resource.PleaseSelect",
                             width: '100%',
                             allowClear: true,
                         });

                         $(".mfp-container select[data-display=select2]").select2({
                             placeholder: "@Resource.PleaseSelect",
                             width: '100%',
                             allowClear: true,
                         });

                         $("form").removeData("validator");
                         $("form").removeData("unobtrusiveValidation");
                         $.validator.unobtrusive.parse("form");
                     }
                 }
             }).magnificPopup('open');
         });
    </script>)


@Html.Script(
    @<script>

         function onFailCallSheet() {
             toastr.error('@Resource.SaveError');
         }
         function onSuccessCallSheet(data) {
             if (data.Code == 0) {
                 if (data.Message)
                     toastr.error(data.Message);
                 else
                     toastr.error('@Resource.SaveFailed');
             } else {
                 if (data.Code == 1) {
                     toastr.success('@Resource.UpdateSuccessful');
                     $.magnificPopup.close();
                     oTable.fnFilter('');
                 }
                 if (data) {
                     $(".leadcontent").html(data);


                     $('.mfp-container .date-picker,.mfp-container .datepicker').datepicker({
                         autoclose: true,
                         todayHighlight: true,
                         format: 'dd/mm/yyyy'
                     }).on('changeDate', function (ev) {
                         $(this).datepicker('hide');
                     });

                     $("form").removeData("validator");
                     $("form").removeData("unobtrusiveValidation");
                     $.validator.unobtrusive.parse("form");
                 }

             }
         }
         $(document).on('click', '#leadsave_exist', function (e) {
             e.preventDefault();
             $(".typeSubmit").val("SaveExist");
             $(this).parents("form").submit();
         });
         $(document).on('click', '#leadsave_call', function (e) {
             e.preventDefault();
             $(".typeSubmit").val("SaveCall");
             $(this).parents("form").submit();
         });
    </script>)

@Html.Script(
    @<script>

         function onFailCalling() {
             toastr.error('@Resource.SaveError');
         }
         function onSuccessCalling(data) {
             if (data.Code == 0) {
                 if (data.Message)
                     toastr.error(data.Message);
                 else
                     toastr.error('@Resource.SaveFailed');
             } else {
                 if (data.Code == 1) {
                     toastr.success('@Resource.UpdateSuccessful');
                     $.magnificPopup.close();
                     oTable.fnFilter('');
                 }
                 //if (data) {
                 //    $(".leadcontent").html(data);
                 //}

             }
         }
         $(document).on('click', '#endcall_save', function (e) {
             e.preventDefault();
             $(".typeSubmit").val("SaveExist");
             $(this).parents("form").submit();
         });
         $(document).on('click', '#endcall_book', function (e) {
             e.preventDefault();
             $(".typeSubmit").val("SaveBook");
             $(this).parents("form").submit();
         });
         $(document).on('click', '#endcall_requestncl', function (e) {
             e.preventDefault();
             $(".typeSubmit").val("SaveRequestNCL");
             $(this).parents("form").submit();
         });
    </script>)

@Html.Script(
    @<script>

         $(document).on('click', '#request_close', function (e) {
             e.preventDefault();
             $.magnificPopup.close();
         });

         $(document).on('click', '#request_submit', function (e) {
             e.preventDefault();
             var formdata = new FormData();
             formdata.append("id", $("#request_id").val());
             formdata.append("requestType", $("#request_Type").val());
             var getfile = $('#request-attachment')[0];
             if (getfile) {
                 for (var i = 0; i < getfile.files.length; i++) {
                     if (getfile.files[i].name) {
                         formdata.append("AttachmentFile", getfile.files[i]);
                     }
                 }
             }
             $.ajax({
                 url: '@Url.Action("RequestAction")',
                 data: formdata,
                 contentType: false,
                 processData: false,
                 async: false,
                 type: 'POST',
                 success: function (data) {
                     if (data == "") {
                         toastr.success("Submit successful");
                         oTable.fnFilter('');
                     } else {
                         toastr.error(data);
                     }
                 },
                 error: function () {
                     toastr.error("Submit failed");
                 }
             });
         });

    </script>)