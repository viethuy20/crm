@using NS
@using PQT.Domain.Enum
@using Quartz.Util
@using Resources
@model PQT.Web.Models.CallingModel
@{
    ViewBag.Title = "Start Call";
}
<style>
    #crtable tbody tr {
        cursor: pointer;
    }

        #crtable tbody tr:hover {
            background-color: #f2f2f2;
        }


    #grid_companies tbody tr {
        cursor: pointer;
    }

        #grid_companies tbody tr.Tier1 {
            color: #a94442;
            background-color: #ffdad7;
        }

            #grid_companies tbody tr.Tier1.selected {
                color: #a94442;
                background-color: #fcaca6;
            }

        #grid_companies tbody tr.Tier2 {
            color: #31708f;
            background-color: #d8edff !important;
        }

            #grid_companies tbody tr.Tier2.selected {
                color: #31708f;
                background-color: #add9ff !important;
            }

        #grid_companies tbody tr.Tier3.selected {
            color: #313534;
            background-color: #e5e6e6 !important;
        }
</style>
<section>
    <div class="row">
        <div class="col-md-12" style="padding-bottom: 12px;">
            @Html.Bootstrap().ActionLinkButton(Resource.ButtonBackToList, "Index").RouteValues(new { id = Model.EventID }).PrependIcon("md md-arrow-back")
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="card  card-underline">
                <div class="card-head">
                    <header><span class="text-primary"><i class="fa fa-fw fa-phone"></i> @ViewBag.Title</span> - <span style="font-size: 18px;"><b>@Model.Event.EventName (@Model.Event.EventCode)</b> - Sales Date: <b>@Model.Event.StartDate.ToString("dd/MM/yy")</b> - <b>@Model.Event.EndDate.ToString("dd/MM/yy")</b></span></header>
                </div><!--end .card-head -->
                <div class="card-body">
                    <div id="rootwizard2" class="form-wizard form-wizard-horizontal">
                        @using (Html.BeginForm("StartCallForm", "Lead", FormMethod.Post, new { @class = "form form-validation" }))
                        {
                            <div class="form-wizard-nav">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-primary"></div>
                                </div>
                                <ul class="nav nav-justified">
                                    <li class="active"><a href="#step1" data-toggle="tab"><span class="step">1</span> <span class="title">SELECT COMPANY RESOURCE</span></a></li>
                                    <li><a href="#step2" data-toggle="tab"><span class="step">2</span> <span class="title">START CALL</span></a></li>
                                </ul>
                            </div>
                            <div class="tab-content clearfix">
                                <div class="tab-pane active" id="step1" style="padding-top: 50px; padding-bottom: 50px">
                                    <div class="col-md-5 ">
                                        <div class="card card-underline form-group">
                                            <div class="card-head">
                                                <header>
                                                    <b>Companies List</b>
                                                </header>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <table class="table no-margin" id="grid_companies">
                                                        <thead>
                                                        <tr>
                                                            <th></th>
                                                            <th>Country</th>
                                                            <th>Company</th>
                                                            <th>Product/Service</th>
                                                            <th>Sector</th>
                                                            <th>Industry</th>
                                                        </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                            </div><!--end .card-body -->
                                        </div>
                                    </div>
                                    <div class="col-md-7 ">
                                        <div class="card card-underline form-group">
                                            <div class="card-head">
                                                <header><b>Company Resources</b></header>
                                            </div><!--end .card-head -->
                                            <div class="form">
                                                <div class="card-body companies_resources_content">

                                                </div>
                                            </div>
                                        </div><!--end .card -->
                                    </div>
                                </div><!--end #step1 -->
                                <div class="tab-pane" id="step2" style="padding-top: 50px; padding-bottom: 50px">
                                    @Html.Partial("_CallingInfo", Model)
                                </div><!--end #step2 -->
                                <div class="tab-pane" id="step3" style="padding-top: 100px; padding-bottom: 100px">
                                    <br /><br />
                                    <div id="confirm_kpi"></div>
                                </div><!--end #step3 -->
                            </div><!--end .tab-content -->
                            <ul class="pager wizard">
                                <li class="previous"><a class="btn-raised" href="javascript:void(0);">Previous</a></li>
                                <li class="next"><a class="btn-raised" href="javascript:void(0);">Next</a></li>
                                <li class="finish "><button type="submit" class="btn btn-success pull-right" id="endcall_save"><i class="md md-call-end"></i> Finish Call</button></li>
                            </ul>
                        }
                    </div><!--end .card-body -->
                </div><!--end .card-body -->
            </div><!--end .card -->
        </div>
    </div>
    <div class="row">
        <div class="col-md-12" >
            @Html.Bootstrap().ActionLinkButton(Resource.ButtonBackToList, "Index").RouteValues(new { id = Model.EventID }).PrependIcon("md md-arrow-back")
        </div>
    </div>
</section>
@Html.Script(
    @<script>

         var company_id_selected = $("@Html.JquerySelectorFor(m=>m.CompanyID)");
         var company_name_selected = $("@Html.JquerySelectorFor(m=>m.CompanyName)");
         var company_dialingCode_selected = "";
         var tableCompanies = $("#grid_companies").DataTable({
             "processing": true, // for show progress bar
             "serverSide": true, // for process server side
             "filter": true, // this is for disable filter (search box)
             "orderMulti": false, // for disable multiple column at once
             "stateSave": false,
             "ajax": {
                 "url": "@Url.Action("AjaxGetEventCompanies")?eventId=@Model.EventID",
                 "type": "POST",
                 "datatype": "json",
                 "data": function(d) {
                     d.CountryName = $('#grid_companies_filter').find('input[name="search_country"]').val();
                     d.CompanyName = $('#grid_companies_filter').find('input[name="search_name"]').val();
                     d.ProductService = $('#grid_companies_filter').find('input[name="search_service"]').val();
                     d.Sector = $('#grid_companies_filter').find('input[name="search_sector"]').val();
                     d.Industry = $('#grid_companies_filter').find('input[name="search_industry"]').val();
                 }
             },
             "columns": [
                 { "data": "ID", "name": "ID", "orderable": false },
                 { "data": "Country", "name": "Country", "orderable": true },
                 { "data": "CompanyName", "name": "CompanyName", "orderable": true },
                 { "data": "ProductOrService", "name": "ProductOrService", "orderable": true },
                 { "data": "Sector", "name": "Sector", "orderable": true },
                 { "data": "Industry", "name": "Industry", "orderable": true },
             ],
             'columnDefs': [
                 {
                     'targets': 0,
                     'searchable': false,
                     'orderable': false,
                     'width': '1%',
                     'className': 'dt-body-center',
                     'render': function(data, type, full, meta) {
                         return '<input type="checkbox">';
                     }
                 }
             ],
             "aLengthMenu": [[25, 50, 100, 500, 1000, 2000], [25, 50, 100, 500, 1000, 2000]],
             "iDisplayLength": 25,
             "aaSorting": [[0, "asc"]],
             "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                 var rowId = aData["ID"];
                 $(nRow).find('input[type="checkbox"]').val(rowId);
                 $(nRow).attr('data-id', rowId);
                 $(nRow).addClass('Tier' + aData["Tier"]);
             },
             initComplete: function() {
                 var _table = this;
                 var filter_box = _table.parent().find("#grid_companies_filter");
                 var htmlFilter = '<label>Country:<input type="search" name="search_country" /></label>';
                 htmlFilter += '<label>Company:<input type="search" name="search_name" /></label>';
                 htmlFilter += '<label>Product/Service:<input type="search" name="search_service" /></label>';
                 htmlFilter += '<label>Sector:<input type="search" name="search_sector" /></label>';
                 htmlFilter += '<label>Industry:<input type="search" name="search_industry" /></label>';
                 filter_box.html(htmlFilter);

                 searchBindingKeyUp(_table.parent().find('input[type="search"]'), _table);
             },
         });

         function searchBindingKeyUp(elementSearch, tableElement) {
             elementSearch.unbind();
             var timeOutTyping;
             elementSearch.bind('keyup',
                 function(e) {
                     clearTimeout(timeOutTyping);
                     timeOutTyping = setTimeout(function() {
                             tableElement.fnFilter(elementSearch.eq(0).val());
                         },
                         600);
                 });
         }

         function handelClickOnCheckbox(e, $this, $table) {
             var $row = $($this).closest('tr');

             // Get row data
             var data = $table.row($row).data();

             var allRowSelected = $("#grid_companies tr.selected");
             allRowSelected.each(function (index, item) {
                 $(item).find('input[type="checkbox"]').trigger('click');
             });

             // Get row ID
             var rowId = data.ID;
             var rowCompanyName = data.CompanyName;
             var rowDialingCode = data.DialingCode;


             // If checkbox is checked and row ID is not in list of selected row IDs
             if ($this.checked) {
                 company_id_selected.val(rowId);
                 company_name_selected.val(rowCompanyName);
                 company_dialingCode_selected = rowDialingCode;
                 LoadCompanyResources();
                 // Otherwise, if checkbox is not checked and row ID is in list of selected row IDs
             } else if (!$this.checked) {
                 company_id_selected.val(0);
                 company_name_selected.val("");
                 company_dialingCode_selected = "";
                 ClearDataSelected();
             }
             if ($this.checked) {
                 $row.addClass('selected');
             } else {
                 $row.removeClass('selected');
             }

             // Update state of "Select all" control
             // Prevent click event from propagating to parent
             e.stopPropagation();
         }

         // Handle click on checkbox
         $('#grid_companies tbody').on('click',
             'input[type="checkbox"]',
             function(e) {
                 handelClickOnCheckbox(e, this, tableCompanies);
             });

         // Handle click on table cells with checkboxes
         $('#grid_companies').on('click',
             'tbody td, thead th:first-child',
             function(e) {
                 $(this).parent().find('input[type="checkbox"]').trigger('click');
             });


         function LoadCompanyResources() {
             if (company_id_selected.val() > 0) {
                 $.ajax({
                     url: '@Url.Action("CompanyResourceList")?companyID=' + company_id_selected.val(),
                     type: 'POST',
                     success: function(content) {
                         if (content) {
                             $(".companies_resources_content").html(content);
                         } else {
                             toastr.error("Get companies resource failed");
                         }
                     },
                     error: function() {
                         toastr.error("Get companies resource failed");
                     }
                 });
             } else {
                 $(".companies_resources_content").html("");
             }
         }
    </script>)


@Html.Script(
    @<script>

         var wizard = $('#rootwizard2').bootstrapWizard({
             onTabShow: function (tab, navigation, index) {
                 handleTabShow(tab, navigation, index, $('#rootwizard2'));
                 if (index == 1) {
                     $(".next").addClass("hide");
                     $(".finish").removeClass("hide");
                     LoadEventCompanyInfo();

                     var dialingCodes = $('.dialingCode');
                     dialingCodes.each(function (index, item) {
                         if ($(item).val() == "") {
                             $('.dialingCode').val(company_dialingCode_selected);
                         }
                     });

                     StartTick();
                 } else {
                     $(".next").removeClass("hide");
                     $(".finish").addClass("hide");
                     tickStarted = false;
                 }
                 window.scroll(0, 0);
             },
             onNext: function (tab, navigation, index) {
                 var form = $('#rootwizard2').find('.form-validation');
                 var valid = form.valid();
                 if (!valid) {
                     form.data('validator').focusInvalid();
                     return false;
                 }
             }
         });

         function handleTabShow(tab, navigation, index, wizard) {
             var total = navigation.find('li').length;
             var current = index + 0;
             var percent = (current / (total - 1)) * 100;
             var percentWidth = 100 - (100 / total) + '%';

             navigation.find('li').removeClass('done');
             navigation.find('li.active').prevAll().addClass('done');

             wizard.find('.progress-bar').css({ width: percent + '%' });
             $('.form-wizard-horizontal').find('.progress').css({ 'width': percentWidth });
         };

        function ClearDataSelected() {
            $("@Html.JquerySelectorFor(m => m.JobTitle)").val("");
            $("@Html.JquerySelectorFor(m => m.LineExtension)").val("");
            $("@Html.JquerySelectorFor(m => m.DirectLine)").val("");
            $("@Html.JquerySelectorFor(m => m.Salutation)").val("");
            $("@Html.JquerySelectorFor(m => m.FirstName)").val("");
            $("@Html.JquerySelectorFor(m => m.LastName)").val("");
            $("@Html.JquerySelectorFor(m => m.MobilePhone1)").val("");
            $("@Html.JquerySelectorFor(m => m.MobilePhone2)").val("");
            $("@Html.JquerySelectorFor(m => m.WorkEmail)").val("");
            $("@Html.JquerySelectorFor(m => m.PersonalEmail)").val("");

            //if ($("select.callingCompany").val() != "" && !tickStarted) {
            //    StartTick();
            //}
            var dialingCodes = $('.dialingCode');
            dialingCodes.each(function (index, item) {
                if ($(item).val() == "") {
                    $('.dialingCode').val("");
                }
            });
        }
         $(document).on('click', '#crtable tbody tr', function () {

             $("@Html.JquerySelectorFor(m => m.JobTitle)").val($(this).data("role"));
             $("@Html.JquerySelectorFor(m => m.DirectLine)").val($(this).data("mobilephone"));
             @*$("@Html.JquerySelectorFor(m => m.GeneralLine)").val($(this).data("businessphone"));*@
             $("@Html.JquerySelectorFor(m => m.Salutation)").val($(this).data("salutation"));
             $("@Html.JquerySelectorFor(m => m.FirstName)").val($(this).data("firstname"));
             $("@Html.JquerySelectorFor(m => m.LastName)").val($(this).data("lastname"));
             $("@Html.JquerySelectorFor(m => m.MobilePhone1)").val($(this).data("businessphone"));
             $("@Html.JquerySelectorFor(m => m.MobilePhone2)").val($(this).data("mobilephone"));
             $("@Html.JquerySelectorFor(m => m.WorkEmail)").val($(this).data("workemail"));
             $("@Html.JquerySelectorFor(m => m.PersonalEmail)").val($(this).data("personalemail"));

             //if ($("select.callingCompany").val() != "" && !tickStarted) {
             //    StartTick();
             //}

             var dialingCodes = $('.dialingCode');
             dialingCodes.each(function (index, item) {
                 if ($(item).val() == "") {
                     $('.dialingCode').val(company_dialingCode_selected);
                 }
             });

             
             wizard.bootstrapWizard('next');
         });

         function LoadEventCompanyInfo() {
             if (company_id_selected.val() > 0) {
                 $.ajax({
                     url: '@Url.Action("EventCompanyInfo")?eventId=@Model.EventID&companyID=' + company_id_selected.val(),
                     type: 'POST',
                     success: function (data) {
                         SetEventCompanyInfo(data);
                     },
                     error: function () {
                         SetEventCompanyInfo(null);
                     }
                 });
             } else {
                 SetEventCompanyInfo(null);
             }
         }

        function SetEventCompanyInfo(data) {
            if (data) {
                $("@Html.JquerySelectorFor(m => m.EventCompany.ID)").val(data.ID);
                @*$("@Html.JquerySelectorFor(m => m.EventCompany.EstimatedDelegateNumber)").val(data.EstimatedDelegateNumber);
                $("@Html.JquerySelectorFor(m => m.EventCompany.FirstFollowUpStatus)").val(data.FirstFollowUpStatus);
                $("@Html.JquerySelectorFor(m => m.EventCompany.FinalStatus)").val(data.FinalStatus);
                $("@Html.JquerySelectorFor(m => m.EventCompany.DateNextFollowUp)").val(data.DateNextFollowUp);
                $("@Html.JquerySelectorFor(m => m.EventCompany.BudgetMonth)").val(data.BudgetMonth);
                $("@Html.JquerySelectorFor(m => m.EventCompany.GoodTrainingMonth)").val(data.GoodTrainingMonth);
                $("@Html.JquerySelectorFor(m => m.EventCompany.TopicsInterested)").val(data.TopicsInterested);
                $("@Html.JquerySelectorFor(m => m.EventCompany.LocationInterested)").val(data.LocationInterested);*@
                $("@Html.JquerySelectorFor(m => m.EventCompany.TrainingBudget)").val(data.TrainingBudget);
                $("@Html.JquerySelectorFor(m => m.EventCompany.Remarks)").val(data.Remarks);
            } else {
                $("@Html.JquerySelectorFor(m => m.EventCompany.ID)").val(0);
                @*$("@Html.JquerySelectorFor(m => m.EventCompany.EstimatedDelegateNumber)").val(0);
                $("@Html.JquerySelectorFor(m => m.EventCompany.FirstFollowUpStatus)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.FinalStatus)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.DateNextFollowUp)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.BudgetMonth)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.GoodTrainingMonth)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.TopicsInterested)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.LocationInterested)").val('');*@
                $("@Html.JquerySelectorFor(m => m.EventCompany.TrainingBudget)").val('');
                $("@Html.JquerySelectorFor(m => m.EventCompany.Remarks)").val('');
            }
        }
    </script>
        )